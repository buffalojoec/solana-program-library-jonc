<mxfile host="app.diagrams.net" modified="2020-11-30T16:59:25.610Z" agent="5.0 (X11)" etag="wkJ-jPC3cXz3G3qHRcxK" version="13.10.4" type="github">
  <diagram id="85KTXArhh7WUpwYEsi7C" name="Page-1">
    <mxGraphModel dx="1356" dy="771" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="850" pageHeight="1100" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="m_q8M7kcg3w5fF325DCr-8" value="&lt;div&gt;Deposit&lt;/div&gt;&lt;div&gt;* update stake / withdraw authority from &quot;deposit authority&quot; to &quot;withdraw authority&quot;&lt;/div&gt;&lt;div&gt;* mint pool tokens to given account&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="215" y="60" width="210" height="110" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-9" value="&lt;div&gt;Operations:&lt;/div&gt;&lt;div&gt;* init&lt;br&gt;&lt;/div&gt;&lt;div&gt;* deposit&lt;/div&gt;&lt;div&gt;* withdraw / claim&lt;br&gt;&lt;/div&gt;&lt;div&gt;* update stake total&lt;/div&gt;&lt;div&gt;* set staking auth&lt;/div&gt;&lt;div&gt;* update pool owner&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="20" y="60" width="170" height="110" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-10" value="&lt;div&gt;Stake pool state:&lt;br&gt;&lt;/div&gt;&lt;div&gt;* owner&lt;/div&gt;&lt;div&gt;* pool token mint&lt;/div&gt;&lt;div&gt;* fee account&lt;/div&gt;&lt;div&gt;* fee information&lt;/div&gt;&lt;div&gt;* deposit authority&lt;/div&gt;&lt;div&gt;* withdraw authority&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="20" y="190" width="170" height="210" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-11" value="&lt;div&gt;Withdraw / Claim&lt;br&gt;&lt;/div&gt;&lt;div&gt;* re-assign / merge given stake account to another&lt;/div&gt;&lt;div&gt;* burn equivalent pool tokens&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="210" y="190" width="210" height="110" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-12" value="&lt;div&gt;Update stake total:&lt;/div&gt;&lt;div&gt;* Go through all provided accounts, add all stakes&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="210" y="320" width="210" height="70" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-13" value="Problem:&lt;br&gt;* impossible to pass in enough stake accounts in one instruction and update the total, too many stake accounts under management by stake pool" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="510" y="190" width="260" height="110" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-14" value="To add" style="text;html=1;align=center;verticalAlign=middle;resizable=0;points=[];autosize=1;" vertex="1" parent="1">
          <mxGeometry x="20" y="440" width="50" height="20" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-15" value="&lt;div&gt;Stake pool:&lt;/div&gt;&lt;div&gt;&lt;div&gt;* Hash table max 10k entries&lt;br&gt;&lt;/div&gt;validator pubkey -&amp;gt;&lt;/div&gt;&lt;div&gt;(stake amount, epoch)&lt;/div&gt;&lt;div&gt;* lockup info (checked at deposit)&lt;/div&gt;&lt;div&gt;* whether stake pool is open for deposits (avoid people depositing after start of epoch)&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="20" y="470" width="160" height="180" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-16" value="Sysvar for all stake accounts at the end of each epoch" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="215" y="470" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-17" value="&lt;div&gt;Instruction:&lt;/div&gt;&lt;div&gt;* create stake account at validator key&lt;/div&gt;&lt;div&gt;* use [stake pool key, validator key, stake pool program] as seeds for program address&lt;/div&gt;&lt;div&gt;* only usable by owner, withdraw authority is stake pool&lt;/div&gt;&lt;div&gt;* add entry into hash table&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="410" y="470" width="170" height="140" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-18" value="&lt;div&gt;Instruction:&lt;/div&gt;&lt;div&gt;* merge deposited stake&lt;br&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;to validator stake account&lt;/div&gt;&lt;div&gt;* only usable by owner&lt;br&gt;&lt;/div&gt;" style="whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="620" y="470" width="160" height="80" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-19" value="&lt;div&gt;Update total:&lt;/div&gt;&lt;div&gt;* take in stake account sysvar, start index, amount of accounts to check&lt;br&gt;&lt;/div&gt;&lt;div&gt;* go through hashtable entries, create program address [stake pool key, validator key, stake pool program], find in sysvar, update stake amount / epoch&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="20" y="680" width="160" height="160" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-20" value="&lt;div&gt;Withdraw / claim:&lt;/div&gt;&lt;div&gt;* only allow if hash table is updated in that epoch&lt;br&gt;&lt;/div&gt;" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="215" y="680" width="165" height="60" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-21" value="Questions" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="20" y="870" width="60" height="20" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-22" value="Will stake pool owner be able to steal funds?" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="20" y="920" width="160" height="60" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-23" value="Will stake pool owner be able to manage all stake accounts? Both deposited accounts and validator stake accounts." style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="215" y="920" width="205" height="60" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-24" value="Currently" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;" vertex="1" parent="1">
          <mxGeometry x="20" y="20" width="80" height="20" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-25" value="Any other concerns?" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="450" y="920" width="120" height="60" as="geometry" />
        </mxCell>
        <mxCell id="m_q8M7kcg3w5fF325DCr-26" value="Should we add some workflow for stake pool managers to merge deposited accounts into validator stake accounts?" style="rounded=0;whiteSpace=wrap;html=1;" vertex="1" parent="1">
          <mxGeometry x="610" y="920" width="230" height="60" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
